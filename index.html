<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soil Monitoring System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-dayjs@latest/dist/chartjs-adapter-dayjs.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .active-nav {
            color: #2563eb; /* text-blue-600 */
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app" class="max-w-lg mx-auto bg-white min-h-screen shadow-lg">
        
        <!-- Main Content Area -->
        <main class="p-4 pb-24">
            
            <!-- ====== Dashboard Page ====== -->
            <div id="dashboard-page" class="page active">
                <!-- Header -->
                <header class="flex justify-between items-center mb-6">
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">Farm Plot 1</h1>
                        <p class="text-sm text-gray-500">Last updated: Just now</p>
                    </div>
                    <div class="flex items-center space-x-2 bg-green-100 text-green-800 px-3 py-1 rounded-full">
                        <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                        <span class="text-sm font-medium">Optimal</span>
                    </div>
                </header>

                <!-- Critical Metrics Cards -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg cursor-pointer" onclick="navigateToHistory('moisture')">
                        <div class="flex items-center space-x-2 mb-2">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-blue-600"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>
                            <h3 class="font-semibold text-gray-700">Moisture</h3>
                        </div>
                        <p class="text-3xl font-bold text-gray-900">58<span class="text-xl">%</span></p>
                        <p class="text-sm text-green-600 font-medium">Healthy</p>
                    </div>
                    <div class="bg-green-50 border border-green-200 p-4 rounded-lg cursor-pointer" onclick="navigateToHistory('n')">
                        <div class="flex items-center space-x-2 mb-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-green-600"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                            <h3 class="font-semibold text-gray-700">NPK Status</h3>
                        </div>
                        <p class="text-3xl font-bold text-gray-900">Good</p>
                        <p class="text-sm text-green-600 font-medium">Optimal</p>
                    </div>
                </div>

                <!-- NPK Breakdown -->
                <div class="mb-6">
                    <h3 class="font-semibold text-gray-700 mb-2">NPK Breakdown</h3>
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div class="bg-gray-100 p-3 rounded-lg">
                            <p class="text-sm text-gray-500">Nitrogen (N)</p>
                            <p class="text-lg font-bold">18 <span class="text-sm font-normal">ppm</span></p>
                        </div>
                         <div class="bg-gray-100 p-3 rounded-lg">
                            <p class="text-sm text-gray-500">Phosphorus (P)</p>
                            <p class="text-lg font-bold">35 <span class="text-sm font-normal">ppm</span></p>
                        </div>
                         <div class="bg-yellow-50 border border-yellow-200 p-3 rounded-lg">
                            <p class="text-sm text-yellow-700">Potassium (K)</p>
                            <p class="text-lg font-bold text-yellow-900">75 <span class="text-sm font-normal">ppm</span></p>
                        </div>
                    </div>
                </div>
                
                <!-- Environmental & Weather -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <!-- Environmental Stats -->
                    <div>
                         <h3 class="font-semibold text-gray-700 mb-2">Environment</h3>
                         <div class="space-y-2">
                             <div class="bg-gray-100 p-3 rounded-lg flex items-center justify-between">
                                 <div class="flex items-center space-x-2">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-red-500"><path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z"/></svg>
                                     <span class="text-sm">Amb. Temp</span>
                                 </div>
                                 <span class="font-bold" id="dashboard-temp">--°C</span>
                             </div>
                             <div class="bg-gray-100 p-3 rounded-lg flex items-center justify-between">
                                 <div class="flex items-center space-x-2">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-orange-600"><path d="m14 4-3 3 3 3"/><path d="M4 14h11.5a4.5 4.5 0 0 0 0-9H11"/></svg>
                                     <span class="text-sm">Soil Temp</span>
                                 </div>
                                 <span class="font-bold" id="dashboard-soil-temp">--°C</span>
                             </div>
                             <div class="bg-gray-100 p-3 rounded-lg flex items-center justify-between">
                                 <div class="flex items-center space-x-2">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-blue-500"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>
                                     <span class="text-sm">Humidity</span>
                                 </div>
                                 <span class="font-bold" id="dashboard-humidity">--%</span>
                             </div>
                         </div>
                    </div>
                     <!-- Weather Forecast -->
                    <div>
                        <h3 class="font-semibold text-gray-700 mb-2">Weather (Nagpur)</h3>
                         <div class="bg-indigo-50 border border-indigo-200 p-3 rounded-lg text-center h-full flex flex-col justify-center">
                            <img id="weather-icon" src="https://placehold.co/40x40/9fa8da/9fa8da?text=..." class="w-10 h-10 mx-auto mb-1 rounded-full" alt="Weather icon">
                             <p id="weather-temp" class="font-bold text-lg">--°C</p>
                             <p id="weather-desc" class="text-sm text-indigo-800 capitalize">Loading...</p>
                             <p id="weather-rain" class="text-xs text-gray-500">--% Chance of Rain</p>
                        </div>
                    </div>
                </div>

                <!-- Alerts / Action Feed -->
                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">Action Feed</h3>
                    <div class="space-y-3" id="action-feed-list">
                        <div class="bg-yellow-100 text-yellow-800 p-3 rounded-lg flex items-start space-x-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mt-0.5 flex-shrink-0"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
                            <div>
                                <p class="font-semibold text-sm">Caution: Potassium Low</p>
                                <p class="text-xs">Potassium level is at 75 ppm. Consider adding potassium-rich fertilizer. </p>
                            </div>
                        </div>
                        <div id="weather-insight-placeholder" class="bg-gray-100 text-gray-500 p-3 rounded-lg flex items-start space-x-3">
                           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mt-0.5 flex-shrink-0"><path d="m12 14 4-4"/><path d="M12 14 8 10"/></svg>
                            <div>
                                <p class="font-semibold text-sm">Loading Weather Insight...</p>
                                <p class="text-xs">Checking forecast data...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ====== History Page ====== -->
            <div id="history-page" class="page">
                 <header class="flex items-center mb-4">
                    <button onclick="navigateTo('dashboard-page')" class="p-2 -ml-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="m15 18-6-6 6-6"/></svg>
                    </button>
                    <h1 class="text-xl font-bold text-gray-900 ml-2">History & Trends</h1>
                </header>

                <!-- Parameter Selector -->
                <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg mb-4" id="metric-tabs">
                    <button data-metric="moisture" class="metric-tab flex-1 p-2 rounded-md text-sm font-medium">Moisture</button>
                    <button data-metric="n" class="metric-tab flex-1 p-2 rounded-md text-sm font-medium">Nitrogen</button>
                    <button data-metric="p" class="metric-tab flex-1 p-2 rounded-md text-sm font-medium">Phosphorus</button>
                    <button data-metric="k" class="metric-tab flex-1 p-2 rounded-md text-sm font-medium">Potassium</button>
                    <button data-metric="temperature" class="metric-tab flex-1 p-2 rounded-md text-sm font-medium">Amb. Temp</button>
                    <button data-metric="humidity" class="metric-tab flex-1 p-2 rounded-md text-sm font-medium">Humidity</button>
                    <button data-metric="soil_temperature" class="metric-tab flex-1 p-2 rounded-md text-sm font-medium">Soil Temp</button>
                </div>
                
                <h2 id="chart-title" class="text-lg font-semibold mb-2"></h2>

                <!-- Interactive Graph -->
                <div class="bg-gray-50 p-2 rounded-lg mb-4">
                    <canvas id="historyChart"></canvas>
                </div>

                <!-- Time Frame Selector -->
                <div class="flex justify-center space-x-2 mb-6" id="time-tabs">
                    <button data-time="1" class="time-tab text-sm px-3 py-1 rounded-full">1D</button>
                    <button data-time="7" class="time-tab text-sm px-3 py-1 rounded-full">7D</button>
                    <button data-time="30" class="time-tab text-sm px-3 py-1 rounded-full">30D</button>
                </div>

                <!-- Summary Stats -->
                 <div class="grid grid-cols-3 gap-4 text-center mb-6">
                    <div class="bg-gray-100 p-3 rounded-lg">
                        <p class="text-sm text-gray-500">Average</p>
                        <p id="stat-avg" class="text-lg font-bold">-</p>
                    </div>
                     <div class="bg-gray-100 p-3 rounded-lg">
                        <p class="text-sm text-gray-500">Minimum</p>
                        <p id="stat-min" class="text-lg font-bold">-</p>
                    </div>
                     <div class="bg-gray-100 p-3 rounded-lg">
                        <p class="text-sm text-gray-500">Maximum</p>
                        <p id="stat-max" class="text-lg font-bold">-</p>
                    </div>
                </div>
                
                <!-- Recommendation/Insight -->
                <div class="bg-indigo-100 text-indigo-800 p-3 rounded-lg flex items-start space-x-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mt-0.5 flex-shrink-0"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                    <div id="history-insight">
                        <p class="font-semibold text-sm">Insight</p>
                        <p class="text-xs">Select a metric and time frame to see trends and insights.</p>
                    </div>
                </div>
            </div>

            <!-- ====== Settings Page ====== -->
            <div id="settings-page" class="page">
                <header class="flex items-center mb-6">
                    <h1 class="text-xl font-bold text-gray-900">Settings & Management</h1>
                </header>

                <div class="space-y-6">
                    <!-- Plot Management -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Plot Management</h3>
                        <div class="bg-gray-100 p-4 rounded-lg space-y-4">
                            <div>
                                <label for="plot-name" class="block text-sm font-medium text-gray-700">Plot Name</label>
                                <input type="text" id="plot-name" value="Farm Plot 1" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="crop-type" class="block text-sm font-medium text-gray-700">Crop Type</label>
                                <select id="crop-type" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                    <option>Tomatoes</option>
                                    <option selected>Corn</option>
                                    <option>Lettuce</option>
                                    <option>Wheat</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Alert Configuration -->
                     <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Alert Thresholds</h3>
                        <div class="bg-gray-100 p-4 rounded-lg space-y-4">
                            <div>
                                <label for="moisture-alert" class="block text-sm font-medium text-gray-700">Low Moisture Alert (%)</label>
                                <input type="range" min="0" max="100" value="40" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mt-2">
                                <p class="text-right text-sm text-gray-500">40%</p>
                            </div>
                             <div>
                                <label for="temp-alert" class="block text-sm font-medium text-gray-700">High Temperature Alert (°C)</label>
                                <input type="range" min="0" max="50" value="35" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mt-2">
                                <p class="text-right text-sm text-gray-500">35°C</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- System -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">System</h3>
                        <div class="bg-gray-100 p-4 rounded-lg space-y-3">
                            <button class="w-full text-left flex justify-between items-center bg-white p-3 rounded-lg shadow-sm">
                                <span>Calibrate Sensors</span>
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-gray-400"><path d="m9 18 6-6-6-6"/></svg>
                            </button>
                            <div class="w-full text-left flex justify-between items-center bg-white p-3 rounded-lg shadow-sm">
                                <span>Weather Service</span>
                                <div class="flex items-center space-x-2 text-green-600">
                                    <span class="text-sm font-medium">Connected</span>
                                    <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>

        <!-- Bottom Navigation Bar -->
        <nav class="fixed bottom-0 left-0 right-0 max-w-lg mx-auto bg-white border-t border-gray-200 flex justify-around">
            <button onclick="navigateTo('dashboard-page')" class="nav-btn flex-1 flex flex-col items-center justify-center p-3 text-gray-500 active-nav" data-page="dashboard-page">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mb-1"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                <span class="text-xs font-medium">Dashboard</span>
            </button>
            <button onclick="navigateTo('history-page')" class="nav-btn flex-1 flex flex-col items-center justify-center p-3 text-gray-500" data-page="history-page">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mb-1"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>
                <span class="text-xs font-medium">History</span>
            </button>
            <button onclick="navigateTo('settings-page')" class="nav-btn flex-1 flex flex-col items-center justify-center p-3 text-gray-500" data-page="settings-page">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mb-1"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                <span class="text-xs font-medium">Settings</span>
            </button>
        </nav>

    </div>

    <script type="module">
        // Import Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, setLogLevel } from "https://www.w3.org/2000/firebasejs/11.6.1/firebase-firestore.js";

        // --- State and Configuration ---
        let historyChart;
        let currentMetric = 'moisture';
        let currentTimeFrame = 7; // days
        
        let db, auth, appId, userId;
        
        // --- !!! IMPORTANT !!! ---
        // PASTE YOUR FREE API KEY FROM OpenWeatherMap.org HERE
        const OPENWEATHER_API_KEY = 'c7f07be63d991f8089667ce1f9fd79ae';
        // Coordinates for Nagpur, India
        const WEATHER_LAT = 21.1458;
        const WEATHER_LON = 79.0882;
        
        const chartConfig = {
            moisture: { label: 'Moisture', unit: '%', color: 'rgb(37, 99, 235)', range: [40, 70] },
            n: { label: 'Nitrogen', unit: 'ppm', color: 'rgb(22, 163, 74)', range: [10, 25] },
            p: { label: 'Phosphorus', unit: 'ppm', color: 'rgb(217, 119, 6)', range: [20, 40] },
            k: { label: 'Potassium', unit: 'ppm', color: 'rgb(202, 138, 4)', range: [100, 200] },
            temperature: { label: 'Amb. Temp', unit: '°C', color: 'rgb(220, 38, 38)', range: [15, 35] },
            humidity: { label: 'Humidity', unit: '%', color: 'rgb(14, 165, 233)', range: [50, 80] },
            soil_temperature: { label: 'Soil Temp', unit: '°C', color: 'rgb(234, 88, 12)', range: [10, 30] },
        };

        // --- Navigation ---
        function navigateTo(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.toggle('active-nav', btn.dataset.page === pageId);
            });
        }
        
        function navigateToHistory(metric) {
            navigateTo('history-page');
            updateChart(metric, currentTimeFrame);
        }
        
        // --- Chart & Data Logic ---

        // Function to generate sample time-series data (FOR STATIC DATA ONLY)
        function generateStaticData(days, base, volatility, range) {
            const data = [];
            const now = dayjs();
            for (let i = days - 1; i >= 0; i--) {
                const date = now.subtract(i, 'day');
                // Simulate some daily fluctuation and a general trend
                let value = base + (Math.random() - 0.5) * volatility + Math.sin(i / 3) * (volatility / 2);
                value = Math.max(range[0], Math.min(range[1], value)); // Clamp within a reasonable range
                data.push({ x: date.valueOf(), y: parseFloat(value.toFixed(1)) });
            }
            return data;
        }

        // Data store for static sample data
        const staticDataStore = {
            moisture: generateStaticData(30, 55, 10, [30, 80]),
            n: generateStaticData(30, 18, 5, [5, 30]),
            p: generateStaticData(30, 32, 8, [15, 45]),
            k: generateStaticData(30, 110, 40, [70, 220]),
        };
        
        // Data store for LIVE data from Firebase
        let liveDataStore = {
            temperature: [],
            humidity: [],
            soil_temperature: []
        };

        function updateChart(metric, timeFrame) {
            currentMetric = metric;
            currentTimeFrame = parseInt(timeFrame);
            
            const config = chartConfig[metric];
            document.getElementById('chart-title').innerText = `${config.label} Trend`;
            
            let data, values;

            if (metric === 'temperature' || metric === 'humidity' || metric === 'soil_temperature') {
                // Use LIVE data
                data = liveDataStore[metric].slice(-currentTimeFrame);
                values = data.map(d => d.y);
            } else {
                // Use STATIC sample data
                data = staticDataStore[metric].slice(-currentTimeFrame);
                values = data.map(d => d.y);
            }
            
            historyChart.data.labels = data.map(d => d.x);
            historyChart.data.datasets[0].label = config.label;
            historyChart.data.datasets[0].data = data;
            historyChart.data.datasets[0].borderColor = config.color;
            historyChart.data.datasets[0].backgroundColor = config.color + '33'; // Add alpha for fill
            historyChart.options.scales.y.title.text = `${config.label} (${config.unit})`;
            historyChart.update();
            
            if (values.length > 0) {
                updateStats(values, config.unit);
            } else {
                // Show placeholders if no data
                document.getElementById('stat-avg').innerText = `-- ${config.unit}`;
                document.getElementById('stat-min').innerText = `-- ${config.unit}`;
                document.getElementById('stat-max').innerText = `-- ${config.unit}`;
            }
            updateTabs();
            updateInsight();
        }
        
        function updateStats(values, unit) {
            const sum = values.reduce((a, b) => a + b, 0);
            const avg = (sum / values.length) || 0;
            const min = Math.min(...values);
            const max = Math.max(...values);
            
            document.getElementById('stat-avg').innerText = `${avg.toFixed(1)} ${unit}`;
            document.getElementById('stat-min').innerText = `${min.toFixed(1)} ${unit}`;
            document.getElementById('stat-max').innerText = `${max.toFixed(1)} ${unit}`;
        }
        
        function updateTabs() {
            // Metric tabs
            document.querySelectorAll('.metric-tab').forEach(tab => {
                const isActive = tab.dataset.metric === currentMetric;
                tab.classList.toggle('bg-white', isActive);
                tab.classList.toggle('text-gray-900', isActive);
                tab.classList.toggle('shadow-sm', isActive);
                 tab.classList.toggle('text-gray-500', !isActive);
            });
            // Time tabs
            document.querySelectorAll('.time-tab').forEach(tab => {
                const isActive = parseInt(tab.dataset.time) === currentTimeFrame;
                tab.classList.toggle('bg-blue-600', isActive);
                tab.classList.toggle('text-white', isActive);
                tab.classList.toggle('bg-gray-200', !isActive);
                tab.classList.toggle('text-gray-700', !isActive);
            });
        }

        function updateInsight() {
            let data;
            if (currentMetric === 'temperature' || currentMetric === 'humidity' || currentMetric === 'soil_temperature') {
                data = liveDataStore[currentMetric].slice(-currentTimeFrame);
            } else {
                data = staticDataStore[currentMetric].slice(-currentTimeFrame);
            }

            if (data.length < 2) {
                 const insightEl = document.getElementById('history-insight');
                 insightEl.innerHTML = `<p class="font-semibold text-sm">Waiting for data</p><p class="text-xs">Not enough data to show trends. Ensure your ESP32 is sending data.</p>`;
                return;
            }
            
            const firstVal = data[0].y;

            insightEl.innerHTML = `<p class="font-semibold text-sm">${title}</p><p class="text-xs">${text}</p>`;
        }

        // --- Firebase Initialization ---
        async function initializeAppWrapper() {
            try {
                // These global variables are provided by the environment
                const firebaseConfig = JSON.parse(__firebase_config);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); // Enable detailed logs for Firestore

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("User is signed in:", user.uid);
                        userId = user.uid;
                        // User is authenticated, now we can set up data listeners
                        setupFirestoreListeners();
                        // Fetch weather data
                        fetchWeatherData();
                    } else {
                        console.log("User is signed out.");
                        userId = null;
                    }
                });

                if (typeof __initial_auth_token !== 'undefined') {
                    console.log("Signing in with custom token...");
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    console.log("Signing in anonymously...");
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                // Display error to user
                document.body.innerHTML = `<div class="p-4 text-red-700 bg-red-100">Error: Could not connect to Firebase. ${error.message}</div>`;
            }
        }
        
        // --- Firestore Data Listener ---
        function setupFirestoreListeners() {
            if (!db || !appId) {
                console.error("Firestore or AppID not initialized.");
                return;
            }
            
            // 1. Listener for DHT11 (Ambient Temp/Humidity)
            const dht11CollectionPath = `/artifacts/${appId}/public/data/dht11_readings`;
            console.log("Listening for DHT11 data at:", dht11CollectionPath);
            const dht11Query = query(collection(db, dht11CollectionPath));

            onSnapshot(dht11Query, (snapshot) => {
                console.log("Received DHT11 snapshot with", snapshot.size, "documents.");
                const readings = [];
                snapshot.forEach(doc => {
                    readings.push(doc.data());
                });

                // Sort in JavaScript since we can't use orderBy
                readings.sort((a, b) => b.timestamp - a.timestamp); // Sort descending (newest first)
                
                if (readings.length > 0) {
                    const latestReading = readings[0];
                    console.log("Latest reading:", latestReading);

                    // Update dashboard
                    const tempEl = document.getElementById('dashboard-temp');
                    const humEl = document.getElementById('dashboard-humidity');
                    if (tempEl) tempEl.innerText = `${latestReading.temperature.toFixed(1)}°C`;
                    if (humEl) humEl.innerText = `${latestReading.humidity.toFixed(1)}%`;
                
                    // Prepare data for charts (sort ascending - oldest to newest)
                    const sortedForChart = readings.slice().reverse(); // reverse() modifies in place, so slice() first
                    
                    liveDataStore.temperature = sortedForChart.map(r => ({
                        x: r.timestamp,
                        y: r.temperature
                    }));
                    
                    liveDataStore.humidity = sortedForChart.map(r => ({
                        x: r.timestamp,
                        y: r.humidity
                    }));
                    
                    // Refresh chart if it's active
                    if (currentMetric === 'temperature' || currentMetric === 'humidity') {
                        updateChart(currentMetric, currentTimeFrame);
                    }
                } else {
                    console.log("No DHT11 data in collection yet.");
                }
            }, (error) => {
                console.error("Error listening to DHT11 Firestore:", error);
            });

            // 2. Listener for DS18B20 (Soil Temp)
            const ds18b20CollectionPath = `/artifacts/${appId}/public/data/ds18b20_readings`;
            console.log("Listening for DS18B20 data at:", ds18b20CollectionPath);
            const ds18b20Query = query(collection(db, ds18b20CollectionPath));

            onSnapshot(ds18b20Query, (snapshot) => {
                console.log("Received DS18B20 snapshot with", snapshot.size, "documents.");
                const readings = [];
                snapshot.forEach(doc => {
                    readings.push(doc.data());
                });

                readings.sort((a, b) => b.timestamp - a.timestamp); // Sort descending
                
                if (readings.length > 0) {
                    const latestReading = readings[0];
                    console.log("Latest soil temp reading:", latestReading);

                    // Update dashboard
                    const soilTempEl = document.getElementById('dashboard-soil-temp');
                    if (soilTempEl) soilTempEl.innerText = `${latestReading.soil_temperature.toFixed(1)}°C`;
                
                    // Prepare data for chart
                    const sortedForChart = readings.slice().reverse();
                    
                    liveDataStore.soil_temperature = sortedForChart.map(r => ({
                        x: r.timestamp,
                        y: r.soil_temperature
                    }));
                    
                    // Refresh chart if it's active
                    if (currentMetric === 'soil_temperature') {
                        updateChart(currentMetric, currentTimeFrame);
                    }
                } else {
                    console.log("No DS18B20 data in collection yet.");
                }
            }, (error) => {
                console.error("Error listening to DS18B20 Firestore:", error);
            });
        }
        
        // --- Weather API Logic ---
        async function fetchWeatherData() {
            if (OPENWEATHER_API_KEY === 'YOUR_OPENWEATHER_API_KEY') {
                console.warn("OpenWeather API Key is not set. Skipping weather fetch.");
                document.getElementById('weather-desc').innerText = "Set API Key";
                return;
            }

            // Using One Call API 3.0 for forecast data
            const apiUrl = `https://api.openweathermap.org/data/3.0/onecall?lat=${WEATHER_LAT}&lon=${WEATHER_LON}&exclude=minutely,hourly,alerts&appid=${OPENWEATHER_API_KEY}&units=metric`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`Weather API error: ${response.statusText}`);
                }
                const data = await response.json();
                console.log("Weather data fetched:", data);

                // Update Dashboard Weather Card
                const current = data.current;
                document.getElementById('weather-temp').innerText = `${current.temp.toFixed(0)}°C`;
                document.getElementById('weather-desc').innerText = current.weather[0].description;
                document.getElementById('weather-icon').src = `https://openweathermap.org/img/wn/${current.weather[0].icon}.png`;

                // Get rain probability for today (from daily forecast)
                const todayForecast = data.daily[0];
                const rainProb = (todayForecast.pop || 0) * 100; // 'pop' = probability of precipitation
                document.getElementById('weather-rain').innerText = `${rainProb.toFixed(0)}% Chance of Rain`;

                // Update predictive insight
                updateWeatherInsight(rainProb);

            } catch (error) {
                console.error("Failed to fetch weather data:", error);
                document.getElementById('weather-desc').innerText = "API Error";
            }
        }
        
        function updateWeatherInsight(rainProbability) {
            const insightPlaceholder = document.getElementById('weather-insight-placeholder');
            if (!insightPlaceholder) return;
            
            // Using static moisture data for this example
            const currentMoisture = staticDataStore.moisture[staticDataStore.moisture.length - 1].y;
            const moistureConfig = chartConfig.moisture;
            
            let title = "Weather Insight";
            let text = "Weather data loaded.";
            let classes = "bg-blue-100 text-blue-800"; // Default blue
            
            if (rainProbability > 50) {
                // High chance of rain
                title = "Rain Expected";
                if (currentMoisture < moistureConfig.range[0]) {
                    // Soil is dry
                    text = `Moisture is low, but with a ${rainProbability}% chance of rain, watering may not be needed. Monitor after rain.`;
                    classes = "bg-yellow-100 text-yellow-800"; // Caution
                } else {
                    // Soil is fine
                    text = `Moisture is optimal, and with ${rainProbability}% chance of rain, soil will be well-watered.`;
                    classes = "bg-blue-100 text-blue-800"; // Info
                }
            } else {
                // Low chance of rain
                title = "Dry Forecast";
                if (currentMoisture < moistureConfig.range[0]) {
                    // Soil is dry
                    text = `Moisture is low, and with only a ${rainProbability}% chance of rain, watering is recommended.`;
                    classes = "bg-red-100 text-red-800"; // Alert
                } else {
                    // Soil is fine
                    text = `Moisture is optimal, and no significant rain is expected. Monitor levels as usual.`;
                    classes = "bg-blue-100 text-blue-800"; // Info
                }
            }
            
            insightPlaceholder.className = `p-3 rounded-lg flex items-start space-x-3 ${classes}`;
            insightPlaceholder.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mt-0.5 flex-shrink-0"><path d="m12 14 4-4"/><path d="M12 14 8 10"/></svg>
                <div>
                    <p class="font-semibold text-sm">${title}</p>
                    <p class="text-xs">${text}</p>
                </div>
            `;
        }

        // --- Page Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Firebase first
            initializeAppWrapper();
            
            // Then initialize the chart
            const ctx = document.getElementById('historyChart').getContext('2d');
            historyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        fill: true,
                        borderWidth: 2,
                        tension: 0.3,
                        pointRadius: 0,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                tooltipFormat: 'MMM D, YYYY',
                            },
                            grid: {
                                display: false,
                            },
                        },
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Add event listeners
            document.getElementById('metric-tabs').addEventListener('click', (e) => {
                if(e.target.matches('.metric-tab')) {
                    updateChart(e.target.dataset.metric, currentTimeFrame);
                }
            });

             document.getElementById('time-tabs').addEventListener('click', (e) => {
                if(e.target.matches('.time-tab')) {
                    updateChart(currentMetric, e.target.dataset.time);
                }
            });

            // Initial load
            updateChart('moisture', 7);
            navigateTo('dashboard-page');
        });
    </script>
</body>
</html>


